# UChat - POC ระบบสถานะออนไลน์แบบเรียลไทม์ (TypeScript)

โปรเจ็กนี้เป็น Proof of Concept (POC) สำหรับปรับปรุงระบบสถานะออนไลน์ของแอพพลิเคชัน UChat ให้ทำงานแบบเรียลไทม์และมีประสิทธิภาพมากขึ้น โดยใช้ Firebase Realtime Database และ TypeScript

## เปรียบเทียบกับระบบเดิม

**ระบบเดิม**:

- อัพเดทสถานะทุก 30 วินาที
- ส่งข้อมูลให้ทุกคน แม้จะไม่มีการเปลี่ยนแปลง
- ทำให้เกิดการใช้ทรัพยากรสูงโดยไม่จำเป็น

**ระบบใหม่ (แบบเรียลไทม์)**:

- อัพเดทสถานะทันทีเมื่อมีการเปลี่ยนแปลงจริง
- ใช้ Firebase Realtime Database เพื่อการซิงค์ข้อมูลอัตโนมัติ
- ลดภาระของเซิร์ฟเวอร์และการใช้แบนด์วิดธ์
- ตรวจจับการตัดการเชื่อมต่อโดยอัตโนมัติ
- ใช้ TypeScript เพื่อความปลอดภัยของประเภทข้อมูล (type safety)

## วิธีการทำงาน

1. **การตั้งค่าสถานะเริ่มต้น**: เมื่อผู้ใช้เข้าสู่ระบบ, สถานะจะถูกตั้งเป็น "ออนไลน์" ใน Firebase Realtime Database

2. **การตรวจจับการตัดการเชื่อมต่อ**: Firebase `.info/connected` และ `onDisconnect()` จะตรวจจับเมื่อผู้ใช้ตัดการเชื่อมต่อและอัพเดทสถานะเป็น "ออฟไลน์" โดยอัตโนมัติ

3. **การตรวจจับสถานะของเบราว์เซอร์**: ใช้ `document.visibilityState` เพื่อตรวจสอบว่าผู้ใช้กำลังใช้งานแท็บนี้อยู่หรือไม่

4. **การรับข้อมูลเรียลไทม์**: ไคลเอนต์รับข้อมูลสถานะของผู้ใช้อื่นโดยตรงจาก Firebase โดยไม่ต้องผ่านเซิร์ฟเวอร์หลัก

## โครงสร้างโปรเจ็ก

```
uchat-realtime-status/
  ├── client/                 # โค้ดฝั่งไคลเอนต์
  │   ├── public/             # ไฟล์ static
  │   └── src/
  │       ├── App.tsx         # คอมโพเนนต์หลัก
  │       ├── firebase.ts     # การตั้งค่า Firebase และฟังก์ชันสำหรับจัดการสถานะ
  │       ├── types/          # Type definitions
  │       └── components/     # คอมโพเนนต์ React สำหรับแสดงสถานะ
  │
  └── server/                 # เซิร์ฟเวอร์หลัก (อย่างง่าย)
      └── src/
          ├── index.ts        # ไฟล์หลักของเซิร์ฟเวอร์
          ├── services/       # บริการต่างๆ
          └── types/          # Type definitions
```

## ฟีเจอร์หลัก

- **สถานะแบบเรียลไทม์**: ผู้ใช้เห็นการเปลี่ยนแปลงสถานะของผู้อื่นทันที
- **ตรวจจับการตัดการเชื่อมต่ออัตโนมัติ**: Firebase จะอัพเดทสถานะเป็นออฟไลน์โดยอัตโนมัติเมื่อผู้ใช้ตัดการเชื่อมต่อ
- **ประหยัดทรัพยากร**: ลดการใช้แบนด์วิดธ์และทรัพยากรเซิร์ฟเวอร์
- **สถานะเพิ่มเติม**: รองรับสถานะเพิ่มเติม เช่น "เห็นล่าสุด", "ไม่อยู่", "ออฟไลน์" ฯลฯ
- **Type safety**: ใช้ TypeScript เพื่อลดข้อผิดพลาดและเพิ่มความปลอดภัยของโค้ด

## การติดตั้งและใช้งาน

### ข้อกำหนดเบื้องต้น

- Node.js และ npm
- Firebase Project (สำหรับ Realtime Database)

### การตั้งค่า Firebase

1. สร้างโปรเจ็กใน Firebase Console
2. เปิดใช้งาน Realtime Database
3. ดาวน์โหลด service account key (สำหรับเซิร์ฟเวอร์)
4. อัพเดทการตั้งค่า Firebase ใน `client/src/firebase.ts` และ `server/src/firebase-admin.ts`

### การติดตั้งและรันไคลเอนต์

```bash
cd client
npm install
npm start
```

### การติดตั้งและรันเซิร์ฟเวอร์

```bash
cd server
npm install
npm run dev  # สำหรับการพัฒนา
# หรือ
npm run build
npm start    # สำหรับการใช้งานจริง
```

## การทดสอบ

1. เปิดแอพในหลายแท็บ/อุปกรณ์
2. ลงชื่อเข้าใช้ด้วยผู้ใช้ที่แตกต่างกัน
3. ทดสอบสลับแท็บ, ปิดแท็บ, ตัดการเชื่อมต่อ
4. สังเกตการอัพเดทสถานะแบบเรียลไทม์

## ข้อควรระวัง

- ตรวจสอบ Security Rules ของ Firebase ให้ดีเพื่อป้องกันการเข้าถึงข้อมูลโดยไม่ได้รับอนุญาต
- คำนึงถึงข้อจำกัดการใช้งานฟรีของ Firebase ในระบบที่มีผู้ใช
